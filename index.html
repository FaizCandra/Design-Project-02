<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Durian Realtime</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* =========================================
           1. CSS VARIABLES (Tema Warna)
           ========================================= */
        :root {
            /* Warna LIGHT Mode (Default) */
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #888;
            --shadow: rgba(0,0,0,0.05);
            --border-input: #eee;
            --chart-grid: #ddd;
            --chart-text: #666;
        }

        [data-theme="dark"] {
            /* Warna DARK Mode */
            --bg-body: #1a1a2e;       /* Biru Gelap Malam */
            --bg-card: #16213e;       /* Biru Navy */
            --text-main: #e94560;     /* Aksen Pink/Merah atau Putih */
            --text-sub: #a0a0a0;
            --shadow: rgba(0,0,0,0.3);
            --border-input: #303050;
            --chart-grid: #444;       /* Garis grafik lebih gelap */
            --chart-text: #ccc;       /* Tulisan grafik jadi putih */
        }

        /* Transisi halus saat ganti tema */
        body, .card, .chart-container, .control-panel, input, h1, h3, .value {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main);
            text-align: center; margin: 0; padding: 20px; 
        }

        .container { max-width: 900px; margin: auto; position: relative; }
        
        h1 { color: var(--text-main); margin-bottom: 5px; }
        
        /* Tombol Toggle Theme */
        .theme-switch-wrapper {
            position: absolute; top: 0; right: 0;
            display: flex; align-items: center;
        }
        .btn-theme {
            background: none; border: 2px solid var(--text-main);
            color: var(--text-main); padding: 5px 10px;
            border-radius: 20px; cursor: pointer; font-weight: bold;
        }
        .btn-theme:hover { background: var(--text-main); color: var(--bg-body); }

        .status { font-size: 0.9em; color: var(--text-sub); margin-bottom: 20px; }
        .indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; background: #e74c3c; margin-right: 5px; }
        
        /* Kartu Umur (Tetap Hijau agar Standout) */
        .card-age { 
            background: linear-gradient(135deg, #27ae60, #2ecc71); 
            color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.2); 
        }
        .card-age h3 { color: #e8f5e9; margin: 0; font-size: 1.1em; }
        .age-full-text { font-size: 1.8em; font-weight: bold; margin-top: 10px; color: white !important; }
        .age-full-text span { font-size: 0.6em; font-weight: normal; margin: 0 5px; }

        /* Grid Kartu */
        .card-grid { display: flex; gap: 15px; justify-content: center; margin-bottom: 10px; flex-wrap: wrap; }
        
        .card { 
            background: var(--bg-card); 
            padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 15px var(--shadow); 
            flex: 1; min-width: 100px; 
        }
        .card h3 { margin: 0; font-size: 0.9em; color: var(--text-sub); text-transform: uppercase; }
        .value { font-size: 1.8em; font-weight: bold; color: #2980b9; margin: 10px 0; }
        .unit { font-size: 0.8em; color: var(--text-sub); }

        /* Warna Khusus Value (Biar tetap terang di Dark Mode) */
        .val-moist { color: #3498db; }
        .val-temp { color: #e67e22; }
        .val-ph { color: #9b59b6; }
        .val-npk { color: var(--text-main); } /* Ikut warna tema utama */

        /* Grafik */
        .chart-container { 
            background: var(--bg-card); 
            padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 15px var(--shadow); 
            margin-bottom: 20px; position: relative; height: 500px; 
        }
        
        .chart-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-controls h3 { margin: 0; text-align: left; color: var(--text-main); }
        .chart-controls select { 
            padding: 6px; border-radius: 5px; 
            border: 1px solid var(--border-input); 
            background: var(--bg-body); color: var(--text-main);
            cursor: pointer; margin-right: 5px; 
        }
        .btn-refresh { background-color: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; }
        
        /* Input */
        .control-panel { 
            background: var(--bg-card); 
            padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 15px var(--shadow); 
        }
        .control-panel h3 { color: var(--text-main); }
        .input-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        input { 
            padding: 10px; width: 40%; 
            border: 2px solid var(--border-input); 
            background: var(--bg-body); color: var(--text-main);
            border-radius: 8px; text-align: center; 
        }
        .btn-update { padding: 10px; width: 100%; background: #e67e22; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="theme-switch-wrapper">
        <button class="btn-theme" onclick="toggleTheme()" id="theme-btn">ðŸŒ™ Dark</button>
    </div>

    <h1>Dashboard Durian</h1>
    
    <div class="status">
        <span id="conn-status" class="indicator"></span> <span id="status-text">Menghubungkan...</span>
    </div>

    <!-- KARTU UMUR -->
    <div class="card-age">
        <h3>Umur Tanaman</h3>
        <div class="age-full-text" id="display-umur">-- <span>Tahun</span> -- <span>Hari</span></div>
    </div>

    <!-- PARAMETER TANAH (BARIS 1) -->
    <div class="card-grid">
        <div class="card">
            <h3>Kelembaban</h3>
            <div class="value val-moist"><span id="val-moist">0</span></div>
            <div class="unit">% RH</div>
        </div>
        <div class="card">
            <h3>Suhu Tanah</h3>
            <div class="value val-temp"><span id="val-temp">0</span></div>
            <div class="unit">Â°C</div>
        </div>
        <div class="card">
            <h3>pH Tanah</h3>
            <div class="value val-ph"><span id="val-ph">0</span></div>
            <div class="unit">pH</div>
        </div>
    </div>

    <!-- NUTRISI (BARIS 2) -->
    <div class="card-grid">
        <div class="card">
            <h3>Nitrogen</h3>
            <div class="value val-npk" id="val-n">0</div>
            <div class="unit">mg/kg</div>
        </div>
        <div class="card">
            <h3>Phosphor</h3>
            <div class="value val-npk" id="val-p">0</div>
            <div class="unit">mg/kg</div>
        </div>
        <div class="card">
            <h3>Kalium</h3>
            <div class="value val-npk" id="val-k">0</div>
            <div class="unit">mg/kg</div>
        </div>
    </div>

    <!-- GRAFIK -->
    <div class="chart-container">
        <div class="chart-controls">
            <h3>Grafik Nutrisi (NPK)</h3>
            <div>
                <label for="dataLimit" style="font-size:0.9em; color:var(--text-sub)">Tampilkan:</label>
                <select id="dataLimit" onchange="fetchHistory()">
                    <option value="20">20 Data</option>
                    <option value="50" selected>50 Data</option>
                    <option value="100">100 Data</option>
                    <option value="500">500 Data</option>
                </select>
                <button onclick="fetchHistory()" class="btn-refresh">ðŸ”„ Refresh</button>
            </div>
        </div>
        <canvas id="npkChart"></canvas>
    </div>

    <!-- INPUT -->
    <div class="control-panel">
        <h3>Atur Umur</h3>
        <div class="input-group">
            <input type="number" id="input-thn" placeholder="Tahun">
            <input type="number" id="input-hari" placeholder="Hari">
        </div>
        <button onclick="kirimUmur()" class="btn-update">UPDATE</button>
    </div>
</div>

<script>
    // --- 0. LOGIKA THEME (DARK/LIGHT) ---
    // Cek apakah user pernah menyimpan preferensi tema sebelumnya
    const currentTheme = localStorage.getItem('theme');
    const themeBtn = document.getElementById('theme-btn');
    
    // Set tema awal saat load
    if (currentTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeBtn.innerText = "â˜€ï¸ Light";
    }

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        let targetTheme = 'light';

        if (current === 'dark') {
            targetTheme = 'light';
            themeBtn.innerText = "ðŸŒ™ Dark";
            document.documentElement.setAttribute('data-theme', 'light');
        } else {
            targetTheme = 'dark';
            themeBtn.innerText = "â˜€ï¸ Light";
            document.documentElement.setAttribute('data-theme', 'dark');
        }
        
        // Simpan ke memory browser
        localStorage.setItem('theme', targetTheme);
        
        // Update Warna Grafik agar sesuai tema
        updateChartTheme(targetTheme);
    }

    // Fungsi khusus untuk mengubah warna Grid & Text Grafik
    function updateChartTheme(theme) {
        if (!myChart) return;

        const textColor = theme === 'dark' ? '#cccccc' : '#666666';
        const gridColor = theme === 'dark' ? '#444444' : '#dddddd';

        // Update Axis X & Y
        myChart.options.scales.x.ticks.color = textColor;
        myChart.options.scales.x.grid.color = gridColor;
        myChart.options.scales.y.ticks.color = textColor;
        myChart.options.scales.y.grid.color = gridColor;
        myChart.options.scales.y.title.color = textColor;
        
        // Update Judul Axis
        myChart.options.scales.x.title.color = textColor;
        
        // Update Legend
        myChart.options.plugins.legend.labels.color = textColor;

        myChart.update();
    }

    // --- 1. KONFIGURASI ---
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbzOA1xZ3WpEuxfwNmZ-yaFZWdU5uvPZ1GaJALKIuipsQUIh9dcHDgkboPy9DS7T0ScjhQ/exec";
    const broker = "broker.emqx.io";
    const port = 8084;
    const clientID = "WebDurian-" + parseInt(Math.random() * 100000);

    const topics = {
        moist: "faiz123/durian/moist",
        temp: "faiz123/durian/temp",
        ph: "faiz123/durian/ph",
        n: "faiz123/durian/N",
        p: "faiz123/durian/P",
        k: "faiz123/durian/K",
        umur: "faiz123/durian/umur",
        setUmur: "faiz123/durian/set_umur"
    };

    // --- CHART SETUP ---
    const ctx = document.getElementById('npkChart').getContext('2d');
    
    // Tentukan warna awal grafik berdasarkan tema saat ini
    const initTheme = localStorage.getItem('theme') || 'light';
    const initTextColor = initTheme === 'dark' ? '#cccccc' : '#666666';
    const initGridColor = initTheme === 'dark' ? '#444444' : '#dddddd';

    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [], 
            datasets: [
                { label: 'Nitrogen', data: [], borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', tension: 0.3, fill: true },
                { label: 'Phosphor', data: [], borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', tension: 0.3, fill: true },
                { label: 'Kalium', data: [], borderColor: '#f1c40f', backgroundColor: 'rgba(241, 196, 15, 0.1)', tension: 0.3, fill: true }
            ]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            layout: { padding: { bottom: 20 } },
            scales: { 
                y: { 
                    beginAtZero: true,
                    grid: { color: initGridColor },
                    ticks: { color: initTextColor },
                    title: { display: true, text: 'Konsentrasi (mg/kg)', color: initTextColor, font: { size: 14, weight: 'bold' } }
                },
                x: {
                    grid: { color: initGridColor },
                    ticks: { color: initTextColor, autoSkip: true, maxRotation: 45, minRotation: 45 },
                    title: { display: true, text: 'Waktu', color: initTextColor }
                }
            },
            plugins: {
                legend: { labels: { color: initTextColor } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) { label += ': '; }
                            if (context.parsed.y !== null) { label += context.parsed.y + ' mg/kg'; }
                            return label;
                        }
                    }
                }
            },
            interaction: { mode: 'index', intersect: false }
        }
    });

    // --- MQTT SETUP ---
    const client = new Paho.MQTT.Client(broker, port, clientID);
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    
    client.connect({
        onSuccess: onConnect, 
        onFailure: () => setTimeout(() => client.connect(this), 5000), 
        useSSL: true, 
        keepAliveInterval: 30, 
        cleanSession: true 
    });

    function onConnect() {
        document.getElementById("status-text").innerText = "Terhubung (Live)";
        document.getElementById("status-text").style.color = "#27ae60"; // Hijau tetap
        document.getElementById("conn-status").style.backgroundColor = "#27ae60";
        Object.values(topics).forEach(t => { if(t !== topics.setUmur) client.subscribe(t); });
    }

    function onConnectionLost() {
        document.getElementById("status-text").innerText = "Terputus...";
        document.getElementById("conn-status").style.backgroundColor = "red";
        setTimeout(() => client.connect({ onSuccess: onConnect, useSSL: true }), 5000);
    }

    function onMessageArrived(msg) {
        const topic = msg.destinationName;
        const payload = msg.payloadString;

        if(topic === topics.n) document.getElementById("val-n").innerText = payload;
        if(topic === topics.p) document.getElementById("val-p").innerText = payload;
        if(topic === topics.k) document.getElementById("val-k").innerText = payload;
        if(topic === topics.moist) document.getElementById("val-moist").innerText = payload;
        if(topic === topics.temp) document.getElementById("val-temp").innerText = payload;
        if(topic === topics.ph) document.getElementById("val-ph").innerText = payload;
        
        if(topic === topics.umur) {
            const parts = payload.split(",");
            if(parts.length === 2) document.getElementById("display-umur").innerHTML = parts[0] + " <span>Tahun</span> " + parts[1] + " <span>Hari</span>";
            else document.getElementById("display-umur").innerText = payload;
        }
    }

    // --- GOOGLE SHEETS FETCH ---
    async function fetchHistory() {
        const limit = document.getElementById("dataLimit").value;
        const btn = document.querySelector(".btn-refresh");
        btn.innerText = "â³ Loading...";
        
        try {
            const res = await fetch(SHEET_URL + "?mode=read&limit=" + limit);
            const json = await res.json();
            const labels = [], dN = [], dP = [], dK = [];
            
            if(json.data) {
                json.data.forEach(d => {
                    labels.push(d.waktu);
                    dN.push(d.n); dP.push(d.p); dK.push(d.k);
                });
                myChart.data.labels = labels;
                myChart.data.datasets[0].data = dN;
                myChart.data.datasets[1].data = dP;
                myChart.data.datasets[2].data = dK;
                myChart.update();
            }
        } catch(e) { console.error(e); }
        btn.innerText = "ðŸ”„ Refresh";
    }
    fetchHistory();

    function kirimUmur() {
        let thn = document.getElementById("input-thn").value || "0";
        let hari = document.getElementById("input-hari").value || "0";
        const message = new Paho.MQTT.Message(thn + "," + hari);
        message.destinationName = topics.setUmur;
        client.send(message);
        alert("Perintah Dikirim!");
    }
</script>

</body>
</html>
