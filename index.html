<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Durian Realtime</title>
    
    <!-- Library Paho MQTT (Wajib untuk koneksi ke alat) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <!-- Library Chart.js (Wajib untuk Grafik) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Gaya Tampilan (CSS) - Agar rapi dan responsif */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; text-align: center; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        h1 { color: #2c3e50; margin-bottom: 5px; }
        
        /* Status Koneksi */
        .status { font-size: 0.9em; color: #888; margin-bottom: 20px; }
        .indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; background: #e74c3c; margin-right: 5px; }
        #debug-error { color: red; font-size: 0.8em; margin-top: 5px; display: none; }

        /* Kartu Umur (Warna Hijau) */
        .card-age { 
            background: linear-gradient(135deg, #27ae60, #2ecc71); 
            color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; 
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4); 
        }
        .card-age h3 { color: #e8f5e9; margin: 0 0 10px 0; font-size: 1.1em; opacity: 0.9; }
        .age-full-text { font-size: 1.8em; font-weight: bold; }
        .age-full-text span { font-size: 0.6em; font-weight: normal; opacity: 0.9; margin: 0 5px; }

        /* Grid Kartu NPK */
        .card-grid { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex: 1; min-width: 100px; }
        .card h3 { margin: 0; font-size: 0.9em; color: #666; text-transform: uppercase; }
        .value { font-size: 2em; font-weight: bold; color: #2980b9; margin: 10px 0; }
        .unit { font-size: 0.8em; color: #aaa; }

        /* Area Grafik */
        .chart-container {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;
            position: relative; height: 400px; 
        }
        .chart-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-controls select { padding: 8px; border-radius: 5px; border: 1px solid #ddd; cursor: pointer; }
        .btn-refresh { background-color: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
        .btn-refresh:hover { background-color: #2980b9; }

        /* Panel Kontrol Input */
        .control-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .input-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        input { padding: 12px; width: 40%; border: 2px solid #eee; border-radius: 8px; font-size: 1em; text-align: center; }
        
        /* Tombol Update */
        .btn-update { 
            padding: 12px 20px; background-color: #e67e22; color: white; border: none; 
            border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; width: 100%; transition: 0.3s; 
        }
        .btn-update:hover { background-color: #d35400; }
        #feedback-msg { margin-top: 10px; font-size: 0.9em; color: #27ae60; opacity: 0; transition: opacity 0.3s; }
        .error-box { color: #e74c3c; font-size: 0.8em; margin-top: 5px; display: none; background: #fee; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Dashboard Durian</h1>
    
    <!-- Status Koneksi -->
    <div class="status">
        <span id="conn-status" class="indicator"></span> 
        <span id="status-text">Menghubungkan...</span>
        <div id="debug-error"></div>
    </div>

    <!-- KARTU UMUR -->
    <div class="card-age">
        <h3>Umur Tanaman Saat Ini</h3>
        <div class="age-full-text" id="display-umur">
            -- <span>Tahun</span> -- <span>Hari</span>
        </div>
    </div>

    <!-- KARTU NPK -->
    <div class="card-grid">
        <div class="card">
            <h3>Nitrogen</h3>
            <div class="value" id="val-n">0</div>
            <div class="unit">mg/kg</div>
        </div>
        <div class="card">
            <h3>Phosphor</h3>
            <div class="value" id="val-p">0</div>
            <div class="unit">mg/kg</div>
        </div>
        <div class="card">
            <h3>Kalium</h3>
            <div class="value" id="val-k">0</div>
            <div class="unit">mg/kg</div>
        </div>
    </div>

    <!-- AREA GRAFIK HISTORIS -->
    <div class="chart-container">
        <div class="chart-controls">
            <h3 style="margin:0">Riwayat Nutrisi</h3>
            <div>
                <label for="dataLimit" style="font-size:0.9em; color:#666">Tampilkan:</label>
                <select id="dataLimit" onchange="fetchHistory()">
                    <option value="20">20 Data</option>
                    <option value="50" selected>50 Data</option>
                    <option value="100">100 Data</option>
                </select>
                <button onclick="fetchHistory()" class="btn-refresh">ðŸ”„</button>
            </div>
        </div>
        
        <!-- INI ADALAH CANVAS GRAFIK ANDA -->
        <canvas id="npkChart"></canvas>
        <div id="chart-error" class="error-box"></div>
    </div>

    <!-- PANEL INPUT UMUR -->
    <div class="control-panel">
        <h3>Atur Umur Tanaman</h3>
        <div class="input-group">
            <input type="number" id="input-thn" placeholder="Tahun" min="0">
            <input type="number" id="input-hari" placeholder="Hari" min="0" max="365">
        </div>
        <button onclick="kirimUmur()" class="btn-update">UPDATE DATA UMUR</button>
        <div id="feedback-msg">Data berhasil dikirim!</div>
    </div>
</div>

<script>
    // ==========================================
    // 1. KONFIGURASI PENTING
    // ==========================================
    
    // URL Google Sheets (PASTIKAN SUDAH DEPLOY ULANG DAN DAPAT ID BARU)
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbzOA1xZ3WpEuxfwNmZ-yaFZWdU5uvPZ1GaJALKIuipsQUIh9dcHDgkboPy9DS7T0ScjhQ/exec";

    // Konfigurasi MQTT
    const broker = "broker.emqx.io";
    const port = 8084; // Port 8084 (WSS) wajib untuk hosting HTTPS agar tidak diblokir
    const clientID = "WebDurian-" + parseInt(Math.random() * 100000);

    // Daftar Topik
    const topic_N = "faiz123/durian/N";
    const topic_P = "faiz123/durian/P";
    const topic_K = "faiz123/durian/K";
    const topic_Umur = "faiz123/durian/umur";     // Menerima data dari alat
    const topic_SetUmur = "faiz123/durian/set_umur"; // Mengirim perintah ke alat

    // ==========================================
    // 2. SETUP GRAFIK (CHART.JS)
    // ==========================================
    const ctx = document.getElementById('npkChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [], 
            datasets: [
                { label: 'Nitrogen', data: [], borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', tension: 0.3, fill: true, pointRadius: 2 },
                { label: 'Phosphor', data: [], borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', tension: 0.3, fill: true, pointRadius: 2 },
                { label: 'Kalium', data: [], borderColor: '#f1c40f', backgroundColor: 'rgba(241, 196, 15, 0.1)', tension: 0.3, fill: true, pointRadius: 2 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: { y: { beginAtZero: true } }
        }
    });

    // ==========================================
    // 3. FUNGSI AMBIL DATA GRAFIK (GOOGLE SHEETS)
    // ==========================================
    async function fetchHistory() {
        const limit = document.getElementById("dataLimit").value;
        const errBox = document.getElementById("chart-error");
        errBox.style.display = "none";
        
        const btn = document.querySelector(".btn-refresh");
        const oldText = btn.innerText;
        btn.innerText = "â³"; // Ikon Loading

        try {
            // Request ke Google Apps Script (Mode Baca)
            const response = await fetch(SHEET_URL + "?mode=read&limit=" + limit);
            const rawText = await response.text();
            
            // Coba Parse JSON
            let json;
            try {
                json = JSON.parse(rawText);
            } catch (e) {
                throw new Error("Gagal membaca data JSON. Pastikan Google Apps Script sudah di-DEPLOY ULANG dengan benar.");
            }
            
            // Proses Data untuk Grafik
            const labels = [];
            const dN = [], dP = [], dK = [];

            if (json.data && Array.isArray(json.data)) {
                json.data.forEach(item => {
                    labels.push(item.waktu);
                    dN.push(item.n); dP.push(item.p); dK.push(item.k);
                });

                myChart.data.labels = labels;
                myChart.data.datasets[0].data = dN;
                myChart.data.datasets[1].data = dP;
                myChart.data.datasets[2].data = dK;
                myChart.update();
                console.log("Grafik update: " + json.data.length + " data.");
            } else {
                console.warn("Data grafik kosong.");
            }

        } catch (error) {
            console.error(error);
            errBox.style.display = "block";
            errBox.innerText = "Error Grafik: " + error.message;
        } finally {
            btn.innerText = oldText;
        }
    }

    // Load grafik pertama kali
    fetchHistory();

    // ==========================================
    // 4. SETUP KONEKSI MQTT (AUTO RECONNECT)
    // ==========================================
    const client = new Paho.MQTT.Client(broker, port, clientID);

    // Opsi Koneksi
    const options = {
        onSuccess: onConnect,
        onFailure: onFail,
        useSSL: true,           // WAJIB TRUE agar bisa jalan di Hosting HTTPS
        keepAliveInterval: 30,
        cleanSession: true,
        timeout: 5
    };

    // Fungsi Utama Koneksi
    function connectMQTT() {
        console.log("Menghubungkan ke MQTT...");
        client.connect(options);
    }

    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    // Mulai Koneksi
    connectMQTT();

    // --- Callback Saat Berhasil Konek ---
    function onConnect() {
        console.log("Terhubung!");
        document.getElementById("status-text").innerText = "Terhubung (Live)";
        document.getElementById("status-text").style.color = "#27ae60";
        document.getElementById("conn-status").style.backgroundColor = "#27ae60";
        document.getElementById("debug-error").style.display = "none";

        // Subscribe Topik
        client.subscribe(topic_N);
        client.subscribe(topic_P);
        client.subscribe(topic_K);
        client.subscribe(topic_Umur);
    }

    // --- Callback Saat Gagal Konek (Awal) ---
    function onFail(responseObject) {
        console.log("Gagal Konek: " + responseObject.errorMessage);
        showErrorState("Gagal Koneksi. Mencoba lagi dalam 5 detik...");
        
        // Tampilkan detail error di bawah (jika perlu debugging)
        const debugDiv = document.getElementById("debug-error");
        debugDiv.style.display = "block";
        debugDiv.innerText = "Error Code: " + responseObject.errorCode + " | " + responseObject.errorMessage;

        // Coba lagi setelah 5 detik (Auto Reconnect)
        setTimeout(connectMQTT, 5000);
    }

    // --- Callback Saat Koneksi Putus Tiba-tiba ---
    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("Putus Koneksi: " + responseObject.errorMessage);
            showErrorState("Koneksi terputus. Menyambung ulang...");
            // Coba lagi setelah 5 detik
            setTimeout(connectMQTT, 5000);
        }
    }

    // Helper: Update Tampilan saat Error
    function showErrorState(msg) {
        document.getElementById("status-text").innerText = msg;
        document.getElementById("status-text").style.color = "#e74c3c";
        document.getElementById("conn-status").style.backgroundColor = "#e74c3c";
    }

    // --- Callback Saat Pesan Masuk ---
    function onMessageArrived(message) {
        const topic = message.destinationName;
        const payload = message.payloadString;

        if(topic === topic_N) document.getElementById("val-n").innerText = payload;
        if(topic === topic_P) document.getElementById("val-p").innerText = payload;
        if(topic === topic_K) document.getElementById("val-k").innerText = payload;
        
        // Logika Tampilan Umur (Parsing "Tahun,Hari")
        if(topic === topic_Umur) {
            const parts = payload.split(","); 
            const displayDiv = document.getElementById("display-umur");
            if(parts.length === 2) {
                displayDiv.innerHTML = parts[0] + " <span>Tahun</span> " + parts[1] + " <span>Hari</span>";
            } else {
                displayDiv.innerText = payload;
            }
        }
    }

    // ==========================================
    // 5. FUNGSI INPUT UMUR
    // ==========================================
    function kirimUmur() {
        let thn = document.getElementById("input-thn").value;
        let hari = document.getElementById("input-hari").value;
        const msgBox = document.getElementById("feedback-msg");

        if(thn === "") thn = "0";
        if(hari === "") hari = "0";

        // Format yang dikirim ke ESP32: "Tahun,Hari"
        const dataKirim = thn + "," + hari;

        try {
            if (client.isConnected()) {
                const message = new Paho.MQTT.Message(dataKirim);
                message.destinationName = topic_SetUmur;
                client.send(message);

                msgBox.innerText = "Mengirim: " + thn + " Thn " + hari + " Hari...";
                msgBox.style.color = "#27ae60"; 
                msgBox.style.opacity = "1";
                setTimeout(() => { msgBox.style.opacity = "0"; }, 3000);
            } else {
                alert("Tunggu sampai status Terhubung!");
            }
        } catch (e) {
            console.error(e);
            alert("Gagal mengirim data.");
        }
    }
</script>

</body>
</html>
