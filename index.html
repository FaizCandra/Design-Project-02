<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Durian Realtime</title>
    <!-- Library Paho MQTT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <!-- Library Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; text-align: center; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        h1 { color: #2c3e50; margin-bottom: 5px; }
        .status { font-size: 0.9em; color: #888; margin-bottom: 20px; }
        
        /* Kartu Data */
        .card-grid { display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex: 1; min-width: 100px; }
        .card h3 { margin: 0; font-size: 0.9em; color: #666; text-transform: uppercase; }
        .value { font-size: 2em; font-weight: bold; color: #2980b9; margin: 10px 0; }
        .unit { font-size: 0.8em; color: #aaa; }

        /* Kartu Umur */
        .card-age { 
            background: linear-gradient(135deg, #27ae60, #2ecc71); 
            color: white; 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4); 
        }
        .card-age h3 { color: #e8f5e9; margin: 0 0 10px 0; font-size: 1.1em; opacity: 0.9; }
        .age-full-text { font-size: 1.8em; font-weight: bold; color: white; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .age-full-text span { font-size: 0.6em; font-weight: normal; opacity: 0.9; margin-right: 5px; margin-left: 2px; }

        /* Area Grafik */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            position: relative;
            height: 350px; 
        }
        
        /* Kontrol Grafik */
        .chart-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-controls h3 { margin: 0; text-align: left; }
        .chart-controls select { padding: 8px; border-radius: 5px; border: 1px solid #ddd; cursor: pointer; }

        /* Input Section */
        .control-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .input-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        input { padding: 12px; width: 40%; border: 2px solid #eee; border-radius: 8px; font-size: 1em; text-align: center; }
        button { padding: 12px 20px; background-color: #e67e22; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: bold; width: 100%; transition: 0.3s; }
        button:hover { background-color: #d35400; }
        
        .indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; background: #e74c3c; margin-right: 5px; }
        #feedback-msg { margin-top: 10px; font-size: 0.9em; color: #27ae60; min-height: 20px; opacity: 0; transition: opacity 0.3s; }
        
        .btn-refresh { background-color: #3498db; width: auto; font-size: 0.9em; padding: 8px 15px; }
        .error-box { color: #e74c3c; font-size: 0.8em; margin-top: 5px; display: none; background: #fee; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Dashboard Durian</h1>
    <div class="status">
        <span id="conn-status" class="indicator"></span> <span id="status-text">Menghubungkan...</span>
    </div>

    <!-- KARTU UMUR -->
    <div class="card-age">
        <h3>Umur Tanaman Saat Ini</h3>
        <div class="age-full-text" id="display-umur">
            -- <span>Tahun</span> -- <span>Hari</span>
        </div>
    </div>

    <!-- KARTU NPK -->
    <div class="card-grid">
        <div class="card">
            <h3>Nitrogen</h3>
            <div class="value" id="val-n">0</div>
            <div class="unit">mg/kg</div>
        </div>
        <div class="card">
            <h3>Phosphor</h3>
            <div class="value" id="val-p">0</div>
            <div class="unit">mg/kg</div>
        </div>
        <div class="card">
            <h3>Kalium</h3>
            <div class="value" id="val-k">0</div>
            <div class="unit">mg/kg</div>
        </div>
    </div>

    <!-- AREA GRAFIK HISTORIS -->
    <div class="chart-container">
        <div class="chart-controls">
            <h3>Riwayat Nutrisi</h3>
            <!-- DROPDOWN PILIHAN JUMLAH DATA -->
            <div>
                <label for="dataLimit" style="font-size: 0.9em; color: #666;">Tampilkan:</label>
                <select id="dataLimit" onchange="fetchHistory()">
                    <option value="20">20 Data Terakhir</option>
                    <option value="50" selected>50 Data Terakhir</option>
                    <option value="100">100 Data Terakhir</option>
                    <option value="500">500 Data Terakhir</option>
                </select>
                <button onclick="fetchHistory()" class="btn-refresh">ðŸ”„</button>
            </div>
        </div>
        
        <canvas id="npkChart"></canvas>
        <div id="chart-error" class="error-box"></div>
    </div>

    <!-- CONTROL INPUT -->
    <div class="control-panel">
        <h3>Atur Umur Tanaman</h3>
        <div class="input-group">
            <input type="number" id="input-thn" placeholder="Tahun" min="0">
            <input type="number" id="input-hari" placeholder="Hari" min="0" max="365">
        </div>
        <button onclick="kirimUmur()">UPDATE DATA UMUR</button>
        <div id="feedback-msg">Data berhasil dikirim!</div>
    </div>
</div>

<script>
    // --- 1. KONFIGURASI GOOGLE SHEETS ---
    // PASTIKAN URL INI HASIL "NEW DEPLOYMENT" SETELAH MENGUBAH CODE.GS
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbzOA1xZ3WpEuxfwNmZ-yaFZWdU5uvPZ1GaJALKIuipsQUIh9dcHDgkboPy9DS7T0ScjhQ/exec";

    // --- 2. KONFIGURASI MQTT ---
    const broker = "broker.emqx.io";
    const port = 8084;
    const clientID = "WebDurian-" + parseInt(Math.random() * 100000);

    const topic_N = "faiz123/durian/N";
    const topic_P = "faiz123/durian/P";
    const topic_K = "faiz123/durian/K";
    const topic_Umur = "faiz123/durian/umur";
    const topic_SetUmur = "faiz123/durian/set_umur";

    const client = new Paho.MQTT.Client(broker, port, clientID);
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    // --- 3. INIT GRAFIK CHART.JS ---
    const ctx = document.getElementById('npkChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [], 
            datasets: [
                { label: 'Nitrogen', data: [], borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', tension: 0.3, fill: true, pointRadius: 2 },
                { label: 'Phosphor', data: [], borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', tension: 0.3, fill: true, pointRadius: 2 },
                { label: 'Kalium', data: [], borderColor: '#f1c40f', backgroundColor: 'rgba(241, 196, 15, 0.1)', tension: 0.3, fill: true, pointRadius: 2 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // --- 4. FUNGSI LOAD DATA GRAFIK (DINAMIS) ---
    async function fetchHistory() {
        const limit = document.getElementById("dataLimit").value;
        console.log("Mengambil " + limit + " data grafik...");
        
        const errBox = document.getElementById("chart-error");
        errBox.style.display = "none";

        // Ubah text tombol jadi loading
        const btn = document.querySelector(".btn-refresh");
        const originalText = btn.innerText;
        btn.innerText = "â³";

        try {
            // [UPDATE] Mengirim parameter limit ke Google Scripts
            const response = await fetch(SHEET_URL + "?mode=read&limit=" + limit);
            const rawText = await response.text();
            
            let json;
            try {
                json = JSON.parse(rawText);
            } catch (e) {
                throw new Error("Gagal membaca data JSON. Pastikan Script sudah di-DEPLOY ULANG.");
            }
            
            const labels = [];
            const dN = [];
            const dP = [];
            const dK = [];

            if (json.data && Array.isArray(json.data)) {
                json.data.forEach(item => {
                    labels.push(item.waktu);
                    dN.push(item.n);
                    dP.push(item.p);
                    dK.push(item.k);
                });

                myChart.data.labels = labels;
                myChart.data.datasets[0].data = dN;
                myChart.data.datasets[1].data = dP;
                myChart.data.datasets[2].data = dK;
                myChart.update();
                console.log("Grafik diperbarui!", json.data.length + " data.");
            } else {
                console.warn("Format data kosong.");
            }

        } catch (error) {
            console.error("Error:", error);
            errBox.style.display = "block";
            errBox.innerText = "Error: " + error.message;
        } finally {
            btn.innerText = originalText;
        }
    }

    // Panggil saat load pertama kali
    fetchHistory();

    // --- 5. LOGIKA MQTT ---
    const options = { onSuccess: onConnect, onFailure: onFail, useSSL: true };
    client.connect(options);

    function onConnect() {
        document.getElementById("status-text").innerText = "Terhubung (Live)";
        document.getElementById("status-text").style.color = "#27ae60";
        document.getElementById("conn-status").style.backgroundColor = "#27ae60";
        client.subscribe(topic_N); client.subscribe(topic_P); client.subscribe(topic_K); client.subscribe(topic_Umur);
    }

    function onFail(responseObject) {
        document.getElementById("status-text").innerText = "Gagal Koneksi";
        document.getElementById("conn-status").style.backgroundColor = "#e74c3c";
    }

    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            document.getElementById("status-text").innerText = "Terputus";
            document.getElementById("conn-status").style.backgroundColor = "#e74c3c";
        }
    }

    function onMessageArrived(message) {
        const topic = message.destinationName;
        const payload = message.payloadString;

        if(topic === topic_N) document.getElementById("val-n").innerText = payload;
        if(topic === topic_P) document.getElementById("val-p").innerText = payload;
        if(topic === topic_K) document.getElementById("val-k").innerText = payload;
        if(topic === topic_Umur) {
            const parts = payload.split(","); 
            const displayDiv = document.getElementById("display-umur");
            if(parts.length === 2) displayDiv.innerHTML = parts[0] + " <span>Tahun</span> " + parts[1] + " <span>Hari</span>";
            else displayDiv.innerText = payload;
        }
    }

    function kirimUmur() {
        let thn = document.getElementById("input-thn").value || "0";
        let hari = document.getElementById("input-hari").value || "0";
        const msgBox = document.getElementById("feedback-msg");
        const dataKirim = thn + "," + hari;

        try {
            const message = new Paho.MQTT.Message(dataKirim);
            message.destinationName = topic_SetUmur;
            client.send(message);
            msgBox.innerText = "Mengirim...";
            msgBox.style.opacity = "1";
            setTimeout(() => { msgBox.style.opacity = "0"; }, 3000);
        } catch (e) {
            msgBox.innerText = "Gagal kirim.";
        }
    }
</script>

</body>
</html>
